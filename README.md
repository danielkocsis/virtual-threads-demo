# Virtual Threads 

Inspired by [this](https://www.danvega.dev/blog/virtual-threads-spring-boot) great article by Dan Vega.

This small projects is aiming to measure basic performance differences of the same very made up blocking web application considering the following scenarios:

> Spring Boot version is 3.2 and JDK version is 21

1. OS Threads + Spring Web MVC (Tomcat)
2. Virtual Threads + Spring MVC (Tomcat)
3. OS Threads + Spring Reactor (Netty)
4. Virtual Threads + Spring Reactor (Netty)

## Measurement conditions

I used the [Apache Benchmark](https://httpd.apache.org/docs/2.4/programs/ab.html) first, as suggested by Dan, however I run issues with response processing when I used 
Virtual Threads and tried to generate higher load with increased concurrency. I tried [hey](https://github.com/rakyll/hey) next 
and it worked flawlessly, so the results were generated by that.

I tried to simulate a scenario when concurrent requests count is way higher what our infrastructure of the application can handle,
so in case of Apache Tomcat I limited the Tomcat threads to 50% of my machine core count (4) and used the following test parameters:

`hey -n 100 -c 50 http://localhost:8080/httpbin/block/3`

## Results

|             | Virtual Threads ON  |  Virtual Threads Off  |
|-------------|:-------------------:|:---------------------:|
| **Tomcat**  |        7.7s         |          40s          |
| **Reactor** |                     |                       |


### Summary

### Details

For the sceptics :) 

<details>
<summary>Tomcat with Virtual Threads On</summary>

```
hey -n 100 -c 50 http://localhost:8080/httpbin/block/3

Summary:
  Total:	40.0051 secs
  Slowest:	17.1136 secs
  Fastest:	3.1142 secs
  Average:	6.9724 secs
  Requests/sec:	2.4997

  Total data:	897 bytes
  Size/request:	39 bytes

Response time histogram:
  3.114 [1]	|■■■
  4.514 [14]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
  5.914 [0]	|
  7.314 [0]	|
  8.714 [0]	|
  10.114 [0]	|
  11.514 [4]	|■■■■■■■■■■■
  12.914 [0]	|
  14.314 [0]	|
  15.714 [0]	|
  17.114 [4]	|■■■■■■■■■■■


Latency distribution:
  10% in 3.1278 secs
  25% in 3.2048 secs
  50% in 3.7997 secs
  75% in 10.6461 secs
  90% in 16.8909 secs
  95% in 17.1136 secs
  0% in 0.0000 secs

Details (average, fastest, slowest):
  DNS+dialup:	0.0036 secs, 3.1142 secs, 17.1136 secs
  DNS-lookup:	0.0008 secs, 0.0000 secs, 0.0018 secs
  req write:	0.0001 secs, 0.0000 secs, 0.0012 secs
  resp wait:	6.9686 secs, 3.1142 secs, 17.1048 secs
  resp read:	0.0001 secs, 0.0000 secs, 0.0001 secs

Status code distribution:
  [200]	23 responses

Error distribution:
  [77]	Get "http://localhost:8080/httpbin/block/3": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
```
</details>

<details>
<summary>Tomcat with Virtual Threads On</summary>

```
spring.threads.virtual.enabled=true
server.tomcat.threads.max=4

 hey -n 100 -c 50 http://localhost:8080/httpbin/block/3

Summary:
  Total:	7.7112 secs
  Slowest:	4.4568 secs
  Fastest:	3.1099 secs
  Average:	3.3882 secs
  Requests/sec:	12.9681

  Total data:	7200 bytes
  Size/request:	72 bytes

Response time histogram:
  3.110 [1]	|■
  3.245 [39]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
  3.379 [5]	|■■■■■
  3.514 [35]	|■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
  3.649 [12]	|■■■■■■■■■■■■
  3.783 [4]	|■■■■
  3.918 [1]	|■
  4.053 [0]	|
  4.187 [1]	|■
  4.322 [0]	|
  4.457 [2]	|■■


Latency distribution:
  10% in 3.1131 secs
  25% in 3.1172 secs
  50% in 3.4899 secs
  75% in 3.5101 secs
  90% in 3.6078 secs
  95% in 3.7783 secs
  99% in 4.4568 secs

Details (average, fastest, slowest):
  DNS+dialup:	0.0042 secs, 3.1099 secs, 4.4568 secs
  DNS-lookup:	0.0013 secs, 0.0000 secs, 0.0030 secs
  req write:	0.0003 secs, 0.0000 secs, 0.0020 secs
  resp wait:	3.3831 secs, 3.1098 secs, 4.4471 secs
  resp read:	0.0000 secs, 0.0000 secs, 0.0002 secs

Status code distribution:
  [200]	100 responses
```

</details>
